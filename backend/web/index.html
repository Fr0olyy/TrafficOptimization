<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Quantum Traffic Optimizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --primary: #2563eb;
        --secondary: #64748b;
        --success: #16a34a;
        --error: #dc2626;
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e5e7eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: #0f172a;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
      }
      .header {
        text-align: center;
        margin-bottom: 24px;
      }
      .title {
        font-size: 24px;
        margin: 0 0 6px;
      }
      .subtitle {
        color: var(--secondary);
        margin: 0;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .col {
        flex: 1 1 0;
        min-width: 280px;
      }

      .label {
        display: block;
        font-size: 14px;
        margin-bottom: 6px;
        color: var(--secondary);
      }
      .input,
      .select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
      }
      .button {
        appearance: none;
        border: 0;
        border-radius: 8px;
        padding: 10px 14px;
        background: var(--primary);
        color: #fff;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: #334155;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid var(--border);
        color: #111827;
      }

      .progress {
        width: 100%;
        height: 10px;
        background: #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: var(--primary);
        transition: width 0.3s ease;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 12px;
      }
      @media (max-width: 900px) {
        .kpi-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 560px) {
        .kpi-grid {
          grid-template-columns: 1fr;
        }
      }
      .kpi {
        background: #f9fafb;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
        text-align: center;
      }
      .kpi .value {
        font-size: 20px;
        font-weight: 800;
      }
      .kpi .label {
        margin-top: 4px;
        font-size: 12px;
        color: var(--secondary);
      }

      .table-wrap {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px;
        border-bottom: 1px solid var(--border);
      }
      th {
        text-align: left;
        color: var(--secondary);
        background: #f3f4f6;
      }

      .chart-wrap {
        width: 100%;
        overflow-x: auto;
      }
      canvas {
        max-width: 100%;
        height: 320px;
      }

      .hint {
        font-size: 12px;
        color: var(--secondary);
        margin-top: 6px;
      }
      .bad {
        color: var(--error);
      }
      .good {
        color: var(--success);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="title">Quantum Traffic Optimizer</h1>
        <p class="subtitle">
          Классические и квантовые метрики для загруженного графового датасета
        </p>
      </div>

      <!-- Загрузка и параметры -->
      <div class="card">
        <form id="uploadForm">
          <div class="row">
            <div class="col">
              <label class="label">Файл датасета (.csv или .txt)</label>
              <input
                id="fileInput"
                class="input"
                type="file"
                accept=".csv,.txt"
                required
              />
              <div class="hint">
                Формат: graphindex, graphmatrix, routesstartend
              </div>
            </div>
            <div class="col">
              <label class="label">Макс. кубитов (max_qubits)</label>
              <input
                id="maxQubits"
                class="input"
                type="number"
                min="10"
                max="25"
                value="25"
              />
              <div class="hint">
                До 25 (при необходимости бекенд может игнорировать)
              </div>
            </div>
            <div class="col">
              <label class="label">Слои QAOA (layers)</label>
              <input
                id="layers"
                class="input"
                type="number"
                min="1"
                max="8"
                value="2"
              />
              <div class="hint">Количество слоев в QAOA-цепочке</div>
            </div>
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px">
            <button id="submitBtn" type="submit" class="button">
              Запустить обработку
            </button>
            <button id="resetBtn" type="button" class="button btn-outline">
              Сброс
            </button>
          </div>
          <div id="progressBlock" style="margin-top: 12px; display: none">
            <div class="progress">
              <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText" class="hint">Загрузка...</div>
          </div>
        </form>
      </div>

      <!-- Сводка -->
      <div id="summaryCard" class="card" style="display: none">
        <div class="kpi-grid">
          <div class="kpi">
            <div class="value" id="kpiGraphs">0</div>
            <div class="label">Графов обработано</div>
          </div>
          <div class="kpi">
            <div class="value" id="kpiRoutes">~n/a</div>
            <div class="label">Маршрутов/граф (sampled)</div>
          </div>
          <div class="kpi">
            <div class="value" id="kpiAvgImprove">0%</div>
            <div class="label">Среднее улучшение</div>
          </div>
          <div class="kpi">
            <div class="value" id="kpiElapsed">0s</div>
            <div class="label">Время обработки</div>
          </div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap">
          <button id="downloadQuantum" class="button">
            Скачать Quantum CSV
          </button>
          <button id="downloadClassical" class="button btn-secondary">
            Скачать Classical CSV
          </button>
        </div>
      </div>

      <!-- График сравнения скоростей -->
      <div id="chartCard" class="card" style="display: none">
        <h3 style="margin: 0 0 8px">
          Сравнение времени оптимизации (enhanced): classical vs quantum
        </h3>
        <div class="chart-wrap">
          <canvas id="speedChart"></canvas>
        </div>
        <div class="hint">В миллисекундах, по каждому графу.</div>
      </div>

      <!-- Таблица по первому графу -->
      <div id="tableCard" class="card" style="display: none">
        <h3 style="margin: 0 0 8px">
          Детали по графу #<span id="graphIndexTitle">0</span>
        </h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Метрика</th>
                <th>Classical</th>
                <th>Quantum</th>
              </tr>
            </thead>
            <tbody id="metricsBody">
              <!-- наполнение из JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Chart.js с CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      const form = document.getElementById("uploadForm");
      const fileInput = document.getElementById("fileInput");
      const submitBtn = document.getElementById("submitBtn");
      const resetBtn = document.getElementById("resetBtn");
      const progressBlock = document.getElementById("progressBlock");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      const summaryCard = document.getElementById("summaryCard");
      const kpiGraphs = document.getElementById("kpiGraphs");
      const kpiRoutes = document.getElementById("kpiRoutes");
      const kpiAvgImprove = document.getElementById("kpiAvgImprove");
      const kpiElapsed = document.getElementById("kpiElapsed");
      const downloadQuantum = document.getElementById("downloadQuantum");
      const downloadClassical = document.getElementById("downloadClassical");

      const chartCard = document.getElementById("chartCard");
      const tableCard = document.getElementById("tableCard");
      const graphIndexTitle = document.getElementById("graphIndexTitle");
      const metricsBody = document.getElementById("metricsBody");

      const maxQubitsEl = document.getElementById("maxQubits");
      const layersEl = document.getElementById("layers");

      let lastResponse = null;
      let speedChart = null;

      function setProgress(pct, text) {
        progressBar.style.width = pct + "%";
        progressText.textContent = text || "";
      }

      function humanTime(ms) {
        if (!ms || ms < 1000) return (ms || 0) + " ms";
        const sec = Math.floor(ms / 1000);
        if (sec < 60) return sec + " s";
        const min = Math.floor(sec / 60);
        const rem = sec % 60;
        return min + "m " + rem + "s";
      }

      function downloadById(id, filename) {
        const url = "/download?id=" + encodeURIComponent(id);
        fetch(url)
          .then((res) => {
            if (!res.ok) throw new Error("Download failed");
            return res.blob();
          })
          .then((blob) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            document.body.removeChild(a);
          })
          .catch((err) => alert("Ошибка скачивания: " + err.message));
      }

      function renderChart(perGraph) {
        const labels = perGraph.map((g) => "G" + g.graph_index);
        const classicalMs = perGraph.map(
          (g) => g.classical.enhanced.opt_time_ms
        );
        const quantumMs = perGraph.map((g) => g.quantum.enhanced.opt_time_ms);

        const ctx = document.getElementById("speedChart").getContext("2d");
        if (speedChart) {
          speedChart.destroy();
        }
        speedChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Classical enhanced (ms)",
                data: classicalMs,
                backgroundColor: "rgba(2,132,199,0.7)",
              },
              {
                label: "Quantum enhanced (ms)",
                data: quantumMs,
                backgroundColor: "rgba(99,102,241,0.7)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "ms" } },
            },
            plugins: {
              legend: { position: "top" },
              tooltip: { mode: "index", intersect: false },
            },
          },
        });
        chartCard.style.display = "block";
      }

      function renderTable(first) {
        graphIndexTitle.textContent = first.graph_index;
        const rows = [];
        rows.push([
          "Total cost (Baseline=Dijkstra)",
          first.classical.dijkstra.total_cost.toFixed(1),
          "-",
        ]);
        rows.push([
          "Total cost (Quantum enhanced)",
          "-",
          first.quantum.enhanced.total_cost.toFixed(1),
        ]);
        rows.push([
          "Enhanced time (ms)",
          first.classical.enhanced.opt_time_ms,
          first.quantum.enhanced.opt_time_ms,
        ]);
        rows.push([
          "Greedy total cost (sampled)",
          first.classical.greedy.total_cost.toFixed(1),
          first.quantum.greedy.total_cost.toFixed(1),
        ]);
        rows.push([
          "Dijkstra time (ms)",
          first.classical.dijkstra.opt_time_ms,
          first.quantum.dijkstra.opt_time_ms,
        ]);
        rows.push([
          "Speedup",
          "-",
          (first.compare?.quantum_speedup ?? 0).toFixed(2) + "×",
        ]);

        metricsBody.innerHTML = rows
          .map(
            ([m, c, q]) => `
        <tr>
          <td>${m}</td>
          <td>${c}</td>
          <td>${q}</td>
        </tr>
      `
          )
          .join("");
        tableCard.style.display = "block";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const file = fileInput.files[0];
        if (!file) {
          alert("Выберите файл .csv или .txt");
          return;
        }
        submitBtn.disabled = true;
        progressBlock.style.display = "block";
        setProgress(10, "Загрузка файла...");

        try {
          const formData = new FormData();
          formData.append("file", file);

          // Доп. параметры (если бекенд обновлён под них):
          const maxQubits = parseInt(maxQubitsEl.value || "25", 10);
          const layers = parseInt(layersEl.value || "2", 10);
          // Эти поля бекенд сейчас может игнорировать; добавляем для будущей расширяемости:
          formData.append("max_qubits", String(maxQubits));
          formData.append("qaoa_layers", String(layers));

          setProgress(25, "Отправка на сервер...");
          const res = await fetch("/process", {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || "Ошибка на сервере");
          }

          setProgress(60, "Обработка ответа...");
          const data = await res.json();
          lastResponse = data;

          // KPI
          const graphs = data.perGraph?.length || 0;
          kpiGraphs.textContent = graphs;
          const sampled =
            graphs > 0
              ? data.perGraph[0].classical.greedy.sampled_routes || 0
              : 0;
          kpiRoutes.textContent = sampled > 0 ? `~${sampled} sampled` : "~n/a";
          const avgImprovement =
            graphs > 0
              ? data.perGraph.reduce((acc, g) => {
                  const before = g.classical.dijkstra.total_cost;
                  const after = g.quantum.enhanced.total_cost;
                  if (before > 0) acc += ((before - after) / before) * 100;
                  return acc;
                }, 0) / graphs
              : 0;
          kpiAvgImprove.textContent = avgImprovement.toFixed(1) + "%";
          kpiElapsed.textContent = humanTime(data.elapsed_ms || 0);

          summaryCard.style.display = "block";

          // Кнопки скачивания
          downloadQuantum.onclick = () => {
            const id = data.downloads?.quantum_csv;
            if (!id) return alert("Нет id для Quantum CSV");
            downloadById(id, "quantum_routes.csv");
          };
          downloadClassical.onclick = () => {
            const id = data.downloads?.classical_csv;
            if (!id) return alert("Нет id для Classical CSV");
            downloadById(id, "classical_routes.csv");
          };

          // График
          if (graphs > 0) {
            renderChart(data.perGraph);
            renderTable(data.perGraph[0]);
          }

          setProgress(100, "Готово");
        } catch (err) {
          console.error(err);
          alert("Ошибка: " + (err?.message || err));
        } finally {
          submitBtn.disabled = false;
          setTimeout(() => {
            progressBlock.style.display = "none";
          }, 800);
        }
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        lastResponse = null;
        summaryCard.style.display = "none";
        chartCard.style.display = "none";
        tableCard.style.display = "none";
        if (speedChart) speedChart.destroy();
      });
    </script>
  </body>
</html>
